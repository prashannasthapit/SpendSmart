@{
    ViewData["Title"] = "Products";
}

@model List<Product>

<div class="text-center">
    <h1 class="display-4">Products</h1>
    <br/>
    <hr/>
    <h3 class="total-value">Loading total value...</h3>
    <br/>
    <table class="table">
        <thead>
        <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Value</th>
            <th>Description</th>
            <th>Product Type</th>
            <th>Sub Type</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var product in Model)
        {
            <tr>
                <td>@product.Id</td>
                <td>@product.Name</td>
                <td>@product.Value</td>
                <td>@product.Description</td>
                <td>@product.ProductType?.ProductTypeName</td>
                <td>@product.SubType?.SubTypeName</td>
                <td>
                    <a class="btn btn-primary" asp-action="CreateEditProduct" asp-route-id="@product.Id">Edit</a>
                    <button class="btn btn-danger delete-btn" data-id="@product.Id">Delete</button>
                </td>
            </tr>
        }
        </tbody>
    </table>
    <a class="btn btn-secondary" asp-action="CreateEditProduct">Create New</a>
</div>

@section Scripts {
    <script>
        function loadTotalValue() {
            $.ajax({
                url: '@Url.Action("GetTotalValue")',
                method: 'GET',
                success: function(data) {
                    // data is the JSON object { totalValue: someNumber }
                    $('.total-value').text('Total Value: $' + data.totalValue.toFixed(2));
                },
                error: function() {
                    $('.total-value').text('Failed to load total value.');
                }
            });
        }

        $(document).ready(function () {
            loadTotalValue();

            $('.delete-btn').click(function () {
                const id = $(this).data('id');
                const row = $(this).closest('tr');

                if (!confirm("Are you sure you want to delete this product?")) {
                    return;
                }

                $.ajax({
                    url: '@Url.Action("DeleteProduct")',
                    type: 'POST',
                    data: {id: id},
                    traditional: true,
                    success: function () {
                        row.fadeOut(500, function () {
                            $(this).remove();
                            loadTotalValue(); // refresh total after delete
                        });
                    },
                    error: function (xhr) {
                        alert("Delete failed: " + xhr.responseText);
                    }
                });
            });
        });
    </script>
}
